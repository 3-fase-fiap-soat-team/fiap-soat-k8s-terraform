# üöÄ FIAP SOAT - EKS Kubernetes Infrastructure# üöÄ FIAP SOAT - EKS Kubernetes Terraform



Infraestrutura como C√≥digo (IaC) para provisionamento de cluster EKS na AWS usando Terraform, otimizado para AWS Academy.## üìä Status: ‚úÖ PRONTO PARA PRODU√á√ÉO



## üìã √çndice**Data de Update**: 30 de Setembro de 2025  

**Branch**: feature/networking-vpc  

- [Sobre o Projeto](#sobre-o-projeto)**Aplica√ß√£o NestJS**: ‚úÖ Funcionando no EKS

- [Arquitetura](#arquitetura)

- [Pr√©-requisitos](#pr√©-requisitos)---

- [Quick Start](#quick-start)

- [Estrutura do Projeto](#estrutura-do-projeto)## üéØ **O que funciona AGORA**

- [Documenta√ß√£o](#documenta√ß√£o)

- [Scripts √öteis](#scripts-√∫teis)### ‚úÖ Infraestrutura EKS

- [CI/CD](#cicd)- **Cluster EKS**: v1.28 funcional

- [Troubleshooting](#troubleshooting)- **Worker Nodes**: t3.small (1 node)

- **Networking**: VPC + Subnets + Security Groups

## üéØ Sobre o Projeto- **LoadBalancer**: AWS ELB autom√°tico



Este reposit√≥rio cont√©m a infraestrutura Terraform para provisionamento de um cluster Amazon EKS (Elastic Kubernetes Service) otimizado para AWS Academy, com as seguintes caracter√≠sticas:### ‚úÖ Aplica√ß√£o NestJS 

- **Imagem ECR**: Uploadada e funcionando

- **Auto-discovery** de VPC, IAM Roles e Subnets via RDS existente- **Deployment**: Limpo e organizado

- **Security Groups** configur√°veis (criar novos ou reutilizar existentes)- **Service**: LoadBalancer expondo porta 80‚Üí3000

- **GitHub Actions** para CI/CD automatizado- **Health Checks**: Endpoints `/` e `/health`

- **AWS Academy compliant** - funciona com limita√ß√µes do AWS Academy Learner Lab- ‚úÖ **Budget Optimization:** Configurado para $50 USD

- **Cost-optimized** - configura√ß√£o econ√¥mica com t3.micro nodes- ‚úÖ **Scripts de teste:** Prontos e funcionando

- ‚úÖ **Aplica√ß√£o:** Manifests prontos para deploy

### ‚ú® Funcionalidades

## üë®‚Äçüíª **Respons√°vel**

- ‚úÖ Auto-discovery de VPC e Subnets atrav√©s de RDS existente- **Dev 3 (rs94458)** - EKS + Infraestrutura de Integra√ß√£o com App

- ‚úÖ Auto-discovery de IAM Roles (LabEksClusterRole, LabEksNodeRole)- **Reposit√≥rios:** `fiap-soat-k8s-terraform`

- ‚úÖ Security Groups flex√≠veis (cria√ß√£o autom√°tica ou reutiliza√ß√£o)- **Foco:** Cluster EKS + Deploy da aplica√ß√£o

- ‚úÖ EKS Cluster v1.27 com 3 add-ons essenciais- **Tecnologias:** Terraform, AWS EKS, Kubernetes, Docker, CI/CD

- ‚úÖ Node Groups configur√°veis (min/max/desired size)

- ‚úÖ IRSA (IAM Roles for Service Accounts) habilitado## üìÅ **Estrutura do Projeto**

- ‚úÖ Scripts de deploy e manuten√ß√£o automatizados```

- ‚úÖ Testes de carga com Artillery e K6environments/

‚îú‚îÄ‚îÄ dev/               # Ambiente desenvolvimento

## üèóÔ∏è Arquitetura‚îÇ   ‚îú‚îÄ‚îÄ main.tf        # Configura√ß√£o principal EKS

‚îÇ   ‚îú‚îÄ‚îÄ variables.tf   # Vari√°veis do ambiente

```‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf     # Outputs (cluster endpoint, etc)

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ   ‚îî‚îÄ‚îÄ backend.tf     # Backend S3 para state

‚îÇ                       AWS Academy Account                    ‚îÇ‚îú‚îÄ‚îÄ prod/              # Ambiente produ√ß√£o (futuro)

‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§modules/

‚îÇ                                                              ‚îÇ‚îú‚îÄ‚îÄ eks/               # M√≥dulo EKS principal

‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ‚îÇ   ‚îú‚îÄ‚îÄ cluster.tf     # Cluster EKS

‚îÇ  ‚îÇ  VPC (descoberta via RDS)                            ‚îÇ  ‚îÇ‚îÇ   ‚îú‚îÄ‚îÄ node-groups.tf # Node groups

‚îÇ  ‚îÇ  ‚îú‚îÄ 6 Subnets (p√∫blicas/privadas)                    ‚îÇ  ‚îÇ‚îÇ   ‚îú‚îÄ‚îÄ addons.tf      # Add-ons essenciais

‚îÇ  ‚îÇ  ‚îú‚îÄ Security Groups (EKS Cluster + Nodes)            ‚îÇ  ‚îÇ‚îÇ   ‚îî‚îÄ‚îÄ outputs.tf     # Outputs do m√≥dulo

‚îÇ  ‚îÇ  ‚îî‚îÄ RDS PostgreSQL 17.4                              ‚îÇ  ‚îÇ‚îú‚îÄ‚îÄ networking/        # VPC e networking

‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ‚îÇ   ‚îú‚îÄ‚îÄ vpc.tf         # VPC para EKS

‚îÇ                                                              ‚îÇ‚îÇ   ‚îú‚îÄ‚îÄ subnets.tf     # Subnets p√∫blicas/privadas

‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ‚îÇ   ‚îî‚îÄ‚îÄ security.tf    # Security groups

‚îÇ  ‚îÇ  EKS Cluster (fiap-soat-eks-dev)                     ‚îÇ  ‚îÇ‚îú‚îÄ‚îÄ monitoring/        # Observabilidade b√°sica

‚îÇ  ‚îÇ  ‚îú‚îÄ Version: 1.27                                     ‚îÇ  ‚îÇmanifests/

‚îÇ  ‚îÇ  ‚îú‚îÄ IAM: LabEksClusterRole (auto-discovered)         ‚îÇ  ‚îÇ‚îú‚îÄ‚îÄ application/       # Manifests K8s da aplica√ß√£o

‚îÇ  ‚îÇ  ‚îú‚îÄ Add-ons: vpc-cni, kube-proxy, coredns            ‚îÇ  ‚îÇ‚îú‚îÄ‚îÄ ingress/           # Configura√ß√£o Ingress

‚îÇ  ‚îÇ  ‚îî‚îÄ OIDC Provider (IRSA enabled)                     ‚îÇ  ‚îÇ‚îî‚îÄ‚îÄ secrets/           # Secrets Kubernetes

‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ```

‚îÇ                                                              ‚îÇ

‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ## ‚öôÔ∏è **Configura√ß√£o AWS Academy** üéì

‚îÇ  ‚îÇ  Node Group (general)                                 ‚îÇ  ‚îÇ- **Regi√£o:** us-east-1

‚îÇ  ‚îÇ  ‚îú‚îÄ Instance Type: t3.micro                           ‚îÇ  ‚îÇ- **Budget:** $50 USD (AWS Academy Learner Lab)

‚îÇ  ‚îÇ  ‚îú‚îÄ Capacity: ON_DEMAND                               ‚îÇ  ‚îÇ- **IAM Roles:** Usa roles pr√©-criadas do Academy (`LabEksClusterRole`, `LabEksNodeRole`)

‚îÇ  ‚îÇ  ‚îú‚îÄ Min: 1 | Max: 3 | Desired: 2                     ‚îÇ  ‚îÇ- **Node Group:** 1x t3.micro (mais econ√¥mico permitido)

‚îÇ  ‚îÇ  ‚îî‚îÄ IAM: LabEksNodeRole (auto-discovered)            ‚îÇ  ‚îÇ- **Networking:** Subnets p√∫blicas (sem NAT Gateway para economia)

‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ- **Add-ons:** Apenas essenciais (kube-proxy, vpc-cni, coredns)

‚îÇ                                                              ‚îÇ- **Load Balancer:** NodePort/ClusterIP (sem ELB para economia)

‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

```## üöÄ **Quick Start - AWS Academy** ‚ö°



## üì¶ Pr√©-requisitos### **1. Clone e Configure (2 minutos)**

```bash

- **Terraform** >= 1.0git clone https://github.com/3-fase-fiap-soat-team/fiap-soat-k8s-terraform.git

- **AWS CLI** configurado com credenciais AWS Academycd fiap-soat-k8s-terraform

- **kubectl** para interagir com o cluster

- **Git** para controle de vers√£o# Configurar credenciais AWS Academy (cole o conte√∫do do lab)

- **AWS Account** - AWS Academy Learner Lab ativo./scripts/aws-config.sh

```

### Credenciais AWS Academy

### **2. Teste R√°pido (5 minutos)**

As credenciais AWS Academy expiram a cada ~3 horas. Use o script de renova√ß√£o:```bash

# Teste r√°pido e seguro com timeout autom√°tico

```bash./scripts/test-eks-safe.sh

./scripts/aws-config.sh```

# Cole as credenciais e pressione Ctrl+D

```### **3. Deploy da Aplica√ß√£o**

```bash

## üöÄ Quick Start# Configurar kubectl

aws eks update-kubeconfig --region us-east-1 --name fiap-soat-cluster

### 1. Clone o reposit√≥rio

# Deploy da aplica√ß√£o

```bashkubectl apply -f manifests/application/

git clone https://github.com/3-fase-fiap-soat-team/fiap-soat-k8s-terraform.git

cd fiap-soat-k8s-terraform# Verificar

```kubectl get pods

kubectl get services

### 2. Configure credenciais AWS```



```bash## üöÄ **Setup Local**

./scripts/aws-config.sh

# Cole as credenciais AWS Academy quando solicitado### **Op√ß√£o 1: Setup Automatizado (Recomendado)**

``````bash

# Clonar reposit√≥rio

### 3. Configure vari√°veisgit clone https://github.com/3-fase-fiap-soat-team/fiap-soat-k8s-terraform.git

cd fiap-soat-k8s-terraform

```bash

cd environments/dev# Setup completo automatizado

cp terraform.tfvars.example terraform.tfvars./scripts/setup-dev.sh

# Edite terraform.tfvars se necess√°rio```

```

### **Op√ß√£o 2: Setup Manual**

### 4. Deploy```bash

# Configurar Git

```bashgit config user.name "rs94458"

# Inicializar Terraformgit config user.email "seu-email@gmail.com"

terraform init

# Instalar depend√™ncias

# Planejar altera√ß√µes# Terraform

terraform plansudo apt-get install terraform



# Aplicar configura√ß√£o# kubectl

terraform applycurl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"

```sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl



### 5. Configure kubectl# AWS CLI (se necess√°rio)

curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"

```bashunzip awscliv2.zip && sudo ./aws/install

aws eks update-kubeconfig --region us-east-1 --name fiap-soat-eks-dev

kubectl get nodes# Verificar instala√ß√µes

```terraform version

kubectl version --client

## üìÅ Estrutura do Projetoaws --version

```

```

fiap-soat-k8s-terraform/## üîë **Configura√ß√£o AWS Academy**

‚îú‚îÄ‚îÄ environments/

‚îÇ   ‚îî‚îÄ‚îÄ dev/              # Configura√ß√£o do ambiente de desenvolvimento### **Script de Configura√ß√£o R√°pida**

‚îÇ       ‚îú‚îÄ‚îÄ main.tf       # Configura√ß√£o principal (VPC discovery via RDS)```bash

‚îÇ       ‚îú‚îÄ‚îÄ variables.tf  # Vari√°veis do ambiente# Execute o script e cole as credenciais do AWS Academy

‚îÇ       ‚îú‚îÄ‚îÄ outputs.tf    # Outputs do Terraform./scripts/aws-config.sh

‚îÇ       ‚îî‚îÄ‚îÄ terraform.tfvars  # Valores das vari√°veis

‚îú‚îÄ‚îÄ modules/# Cole o conte√∫do completo no formato:

‚îÇ   ‚îú‚îÄ‚îÄ eks/              # M√≥dulo do EKS Cluster# aws_access_key_id=ASIAUCQMSWOI2CB3BP3S

‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cluster.tf    # Cluster + Security Groups + IAM discovery# aws_secret_access_key=ey3nbFY1QZeN57JZC3n0QlGq733TW/bv7fnpSxBr

‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ node_groups.tf# aws_session_token=IQoJb3JpZ2luX2VjEDgaC...

‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ oidc.tf# 

‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ addons.tf# Pressione Ctrl+D para finalizar

‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variables.tf# O script configura automaticamente e testa a conex√£o

‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ outputs.tf```

‚îÇ   ‚îî‚îÄ‚îÄ vpc/              # M√≥dulo VPC (n√£o usado - usamos VPC do RDS)

‚îú‚îÄ‚îÄ manifests/            # Kubernetes manifests### **Verifica√ß√£o**

‚îÇ   ‚îú‚îÄ‚îÄ namespace.yaml```bash

‚îÇ   ‚îú‚îÄ‚îÄ deployment.yaml# Testar se as credenciais est√£o funcionando

‚îÇ   ‚îî‚îÄ‚îÄ service.yamlaws sts get-caller-identity

‚îú‚îÄ‚îÄ scripts/              # Scripts auxiliares```

‚îÇ   ‚îú‚îÄ‚îÄ aws-config.sh     # Renovar credenciais AWS Academy

‚îÇ   ‚îú‚îÄ‚îÄ deploy.sh         # Deploy completo automatizado## üèóÔ∏è **Desenvolvimento**

‚îÇ   ‚îú‚îÄ‚îÄ deploy-from-ecr.sh```bash

‚îÇ   ‚îú‚îÄ‚îÄ force-destroy.sh# Inicializar Terraform

‚îÇ   ‚îî‚îÄ‚îÄ README.mdcd environments/dev

‚îú‚îÄ‚îÄ load-tests/           # Testes de cargaterraform init

‚îÇ   ‚îú‚îÄ‚îÄ artillery/

‚îÇ   ‚îî‚îÄ‚îÄ k6/# Planejar cria√ß√£o do cluster

‚îú‚îÄ‚îÄ docs/                 # Documenta√ß√£o organizadaterraform plan

‚îÇ   ‚îú‚îÄ‚îÄ guides/           # Guias de configura√ß√£o

‚îÇ   ‚îú‚îÄ‚îÄ troubleshooting/  # Solu√ß√µes de problemas# Aplicar mudan√ßas (‚ö†Ô∏è CUIDADO COM CUSTOS!)

‚îÇ   ‚îú‚îÄ‚îÄ analysis/         # An√°lises t√©cnicasterraform apply

‚îÇ   ‚îî‚îÄ‚îÄ archived/         # Documenta√ß√£o hist√≥rica

‚îú‚îÄ‚îÄ .github/# Configurar kubectl

‚îÇ   ‚îî‚îÄ‚îÄ workflows/aws eks update-kubeconfig --region us-east-1 --name fiap-soat-cluster

‚îÇ       ‚îî‚îÄ‚îÄ terraform-eks.yml  # CI/CD pipeline

‚îî‚îÄ‚îÄ README.md             # Este arquivo# Verificar cluster

```kubectl get nodes

kubectl get pods -A

## üìö Documenta√ß√£o

# Deploy da aplica√ß√£o

### Guiaskubectl apply -f ../../manifests/application/



- [IAM Roles Auto-Discovery](docs/guides/IAM-ROLES-AUTO-DISCOVERY.md) - Como funciona a descoberta autom√°tica de roles# Verificar deploy

- [Security Groups Guide](docs/guides/SECURITY-GROUPS-GUIDE.md) - Configura√ß√£o de Security Groupskubectl get pods

- [VPC Discovery via RDS](docs/guides/VPC-DISCOVERY-CONFIRMATION.md) - Como descobrir VPC atrav√©s do RDSkubectl get services

- [ECR Upload Guide](docs/guides/ECR-UPLOAD-GUIDE.md) - Subir imagens para ECR```

- [Deploy Script](docs/guides/DEPLOY-SCRIPT-ENHANCED.md) - Uso do script de deploy

## üí∞ **Otimiza√ß√µes de Custo AWS Academy**

### Troubleshooting```hcl

# Configura√ß√µes ultra-econ√¥micas

- [Problemas Resolvidos](docs/troubleshooting/PROBLEMA-RESOLVIDO.md)node_group_instance_types = ["t3.micro"]    # Mais barato

- [Situa√ß√µes de Emerg√™ncia](docs/troubleshooting/SITUACAO-EMERGENCIAL.md)node_group_desired_size   = 1               # M√≠nimo

- [VPC Orphan Analysis](docs/troubleshooting/VPC-ORPHAN-ANALYSIS.md)node_group_max_size      = 2               # Limite baixo

node_group_min_size      = 1               # M√≠nimo

### An√°lises T√©cnicas

# Sem add-ons pagos

- [Terraform State Analysis](docs/analysis/TERRAFORM-STATE-ANALYSIS.md)cluster_addons = {

- [Project Context Complete](docs/analysis/PROJECT-CONTEXT-COMPLETE.md)  kube-proxy = {}     # Gratuito

  vpc-cni    = {}     # Gratuito  

## üîß Scripts √öteis  coredns    = {}     # Gratuito

  # aws-load-balancer-controller = {} # DESABILITADO (custa $)

### Renovar Credenciais AWS Academy}



```bash# Networking b√°sico

./scripts/aws-config.shenable_nat_gateway = false      # Economia (usar s√≥ subnets p√∫blicas)

```single_nat_gateway = true       # Se precisar de NAT

```

### Deploy Completo Automatizado

## üîÑ **Workflow de Desenvolvimento**

```bash1. **Branch:** `feature/[nome-da-feature]`

./scripts/deploy.sh2. **Desenvolvimento:** Modificar Terraform + manifests K8s

```3. **Teste:** `terraform plan` + valida√ß√£o manifests

4. **PR:** Solicitar review do team

### Deploy de Aplica√ß√£o do ECR5. **CI/CD:** GitHub Actions valida Terraform

6. **Deploy:** Manual para cluster (cuidado com custos)

```bash

./scripts/deploy-from-ecr.sh## üß™ **CI/CD Pipeline**

```- **Trigger:** Push na `main` ou PR

- **Valida√ß√£o:** `terraform validate` + `kubectl --dry-run`

### Destruir Recursos com For√ßa- **Linting:** `tflint` + `kubeval`

- **Plan:** `terraform plan` (coment√°rio no PR)

```bash- **Deploy:** Manual ap√≥s aprova√ß√£o

./scripts/force-destroy.sh

```## ‚ò∏Ô∏è **Recursos Kubernetes**

```yaml

Veja mais detalhes em [scripts/README.md](scripts/README.md).# Exemplo de deploy da aplica√ß√£o

apiVersion: apps/v1

## üîÑ CI/CDkind: Deployment

metadata:

O projeto usa **GitHub Actions** para automa√ß√£o de deploy. O workflow √© acionado em:  name: fiap-soat-app

spec:

- Pull Requests para `main`  replicas: 1  # M√≠nimo para economia

- Push direto na branch `main`  selector:

    matchLabels:

**Arquivo:** `.github/workflows/terraform-eks.yml`      app: fiap-soat-app

  template:

### Secrets Necess√°rios    spec:

      containers:

Configure no GitHub Repository Settings > Secrets:      - name: app

        image: fiap-soat-app:latest

- `AWS_ACCESS_KEY_ID`        ports:

- `AWS_SECRET_ACCESS_KEY`        - containerPort: 3000

- `AWS_SESSION_TOKEN`        resources:

          limits:

## üêõ Troubleshooting            memory: "256Mi"    # Limitado para t3.micro

            cpu: "200m"

### Credenciais Expiradas          requests:

            memory: "128Mi"

**Erro:** `AuthFailure: AWS was not able to validate the provided access credentials`            cpu: "100m"

```

**Solu√ß√£o:**

```bash## üîê **Integra√ß√£o com Outros Reposit√≥rios**

./scripts/aws-config.sh- **Database:** Conecta com RDS via service/endpoint

# Cole novas credenciais do AWS Academy- **Lambda:** Integra√ß√£o via API Gateway

```- **Application:** Deploy da aplica√ß√£o NestJS no cluster



### N√£o Consegue Acessar EC2 VPCs## üîê **Secrets GitHub (Auto-configurados)**

- `AWS_ACCESS_KEY_ID` - Chave de acesso AWS Academy

**Problema:** AWS Academy `voclabs` role n√£o tem permiss√£o `ec2:DescribeVpcs`- `AWS_SECRET_ACCESS_KEY` - Secret de acesso AWS Academy

- `AWS_SESSION_TOKEN` - Token de sess√£o AWS Academy

**Solu√ß√£o:** O projeto usa **auto-discovery via RDS** para contornar essa limita√ß√£o.- `TF_STATE_BUCKET` - Bucket S3 para state

- `TF_STATE_LOCK_TABLE` - DynamoDB para locks

### EKS Cluster N√£o Sobe

## üìã **Comandos √öteis**

**Erro:** `couldn't find resource` para IAM roles```bash

# Verificar estado do cluster

**Solu√ß√£o:** O projeto usa **auto-discovery de IAM roles** - roles s√£o descobertos dinamicamente.kubectl cluster-info

kubectl get nodes -o wide

### Security Groups Incompat√≠veis

# Verificar pods da aplica√ß√£o

**Problema:** Tentativa de reutilizar SGs do RDS para EKSkubectl get pods -l app=fiap-soat-app



**Solu√ß√£o:** Configure `create_security_groups = true` no `terraform.tfvars` para criar SGs espec√≠ficos para EKS.# Logs da aplica√ß√£o

kubectl logs -l app=fiap-soat-app -f

## ü§ù Contribuindo

# Port-forward para testes locais

1. Fork o projetokubectl port-forward service/fiap-soat-app 3000:3000

2. Crie uma branch para sua feature (`git checkout -b feature/nova-feature`)

3. Commit suas mudan√ßas (`git commit -m 'feat: adiciona nova feature'`)# Escalar aplica√ß√£o (se necess√°rio)

4. Push para a branch (`git push origin feature/nova-feature`)kubectl scale deployment fiap-soat-app --replicas=2

5. Abra um Pull Request

# Destruir cluster (IMPORTANTE para economia)

## üìù Licen√ßaterraform destroy

```

Este projeto √© parte do curso FIAP SOAT - Fase 3.

## üìö **Links Importantes**

## üë• Equipe- **Organiza√ß√£o:** https://github.com/3-fase-fiap-soat-team

- **Application Repo:** https://github.com/3-fase-fiap-soat-team/fiap-soat-application

- **Owner:** rs94458- **EKS Docs:** https://docs.aws.amazon.com/eks/

- **Team:** 3-fase-fiap-soat-team- **Kubernetes Docs:** https://kubernetes.io/docs/

- **Project:** fiap-soat-fase3

## ‚ö†Ô∏è **IMPORTANTE - AWS Academy** üéì

## üìû Suporte- **EKS Control Plane:** ~$2.40/dia ($73/m√™s)

- **Worker Nodes:** ~$0.50/dia (t3.micro)

Para d√∫vidas ou problemas:- **Budget total:** $50 USD - Dura ~20 dias com cluster ativo

- **SEMPRE limpar:** Execute `./scripts/emergency-state-cleanup.sh` ou delete via console

1. Consulte a [documenta√ß√£o](docs/)- **CR√çTICO:** Delete cluster no console AWS Academy quando n√£o estiver usando!

2. Verifique o [troubleshooting](docs/troubleshooting/)

3. Abra uma [issue](https://github.com/3-fase-fiap-soat-team/fiap-soat-k8s-terraform/issues)## üõ†Ô∏è **Scripts Inclu√≠dos** üÜï

- `test-eks-safe.sh` - Teste com timeout autom√°tico e limite de custo

---- `emergency-state-cleanup.sh` - Limpeza de emerg√™ncia quando AWS Academy bloqueia CLI

- `force-destroy.sh` - M√∫ltiplas estrat√©gias para destroy

**üéì AWS Academy Optimized** | **üöÄ Production Ready** | **üìä Cost Effective**- `monitor-cleanup.sh` - Monitora recursos ativos

- `aws-config.sh` - Configura√ß√£o autom√°tica de credenciais

## üìã **AWS Academy - Roles Pr√©-criadas** ‚ú®
O AWS Academy fornece roles espec√≠ficas que devem ser usadas:
```hcl
# Automaticamente detectadas pelo Terraform:
cluster_service_role = "LabEksClusterRole"    # Para o cluster EKS
node_instance_role   = "LabEksNodeRole"       # Para worker nodes
```

## üõ°Ô∏è **Seguran√ßa**
- VPC isolada com subnets privadas
- Security Groups restritivos  
- RBAC Kubernetes configurado
- Network Policies (se necess√°rio)
- Secrets Kubernetes para credenciais
- Service Accounts com IAM roles

## üîß **Troubleshooting**
```bash
# Verificar logs do cluster
kubectl logs -n kube-system -l k8s-app=aws-node

# Verificar eventos
kubectl get events --sort-by='.lastTimestamp'

# Verificar resources
kubectl describe node
kubectl top pods

# Verificar EKS add-ons
aws eks describe-cluster --name fiap-soat-cluster
```
